<!-- SAVE_AS: spec/features/tests/spec.md -->

# Автоматизация тестов и покрытия

**Спецификация:** В проекте нужны автоматические тесты, которые гарантируют качество и запускаются при каждом создании pull request, а также формируют и отображают показатели покрытия кода.

## User Stories

- Как разработчик, я хочу запускать все тесты автоматически при создании pull request, чтобы сразу видеть, проходят ли изменения контроль качества.
- Как ревьюер, я хочу видеть сводку покрытия кода в описании pull request, чтобы оценивать влияние изменений на тестовое покрытие.
- Как инженер по качеству, я хочу, чтобы тестовый конвейер блокировал слияние при падениях или падении покрытия ниже порога, чтобы не допустить регрессий в основной ветке.

## Основные сценарии и правила

- В репозитории поддерживается стандартный набор unit- и компонентных тестов на Jest (с Vue Test Utils для компонент), покрывающий критические пользовательские сценарии и бизнес-логику; любые новые фичи сопровождаются тестами.
- При создании или обновлении pull request автоматически запускается CI-конвейер: установка зависимостей, линтинг (если предусмотрен), запуск `npm run test` (обёртка над `jest`) в headless-режиме и генерация отчётов покрытия Istanbul.
- Результат тестового прогона отображается в статусах проверки pull request; при падении хотя бы одного теста или нарушении порогов покрытий ветка считается непроходящей.
- Генерация покрытия через встроенный Istanbul в Jest экспортирует суммарный процент по statements/branches/functions/lines и публикует отчёт в артефактах или комментариях PR; краткая сводка (например, через GitHub Check) обязательна.
- В конвейере настраиваются минимальные пороги покрытия (например, 80% по строкам и 70% по ветвлениям); падение ниже порога приводит к неуспешному статусу.
- Локальный запуск `npm run test` и `npm run test:coverage` воспроизводит тот же сценарий, что и CI (включая отчётность по Istanbul); результаты не зависят от порядка выполнения тестов.
- Для flaky-тестов требуется автоматическая переоценка: максимум одна повторная попытка, далее статус «красный» и создание задачи на стабилизацию.
- Документация по написанию тестов и интерпретации покрытия (для Jest и Istanbul) хранится в репозитории (README или отдельный гайд) и обновляется при изменениях процесса.

## Нефункциональные требования

- Полный прогон Jest-тестов в CI должен укладываться в 10 минут при стандартных ресурсах (2 CPU, 4 GB RAM); требуется оптимизировать параллелизацию при росте пакета тестов.
- Istanbul формирует отчёты покрытия в формате LCOV и HTML; артефакты совместимы с популярными инструментами визуализации (Codecov, Coveralls и т.п.).
- Секреты и токены, используемые в CI, хранятся в защищённых секрет-хранилищах; тесты не должны зависеть от внешних нестабильных сервисов без моков.
- Решение должно работать одинаково для форков и внутренних веток, не требуя ручной настройки прав доступа к артефактам покрытия.
- Конвейер должен быть устойчив к сетевым сбоям: предусмотрена повторная установка зависимостей и кеширование, чтобы минимизировать ложные падения.
- Реализация учитывает локализацию сообщений об ошибках и покрытии на русском или английском языке, чтобы разработчики легко понимали результаты.

## Assumptions

- Основной стек проекта — Vite + Vue/Tailwind (согласно текущему репозиторию); в качестве тестового фреймворка используется Jest (версия 29+) с `@vue/test-utils` и `vue-jest`.
- Для покрытия используется Istanbul, встроенный в Jest; артефакты (LCOV/JSON) публикуются GitHub Actions (или аналогичным CI) для отображения в PR.
- Pull request создаются в GitHub; права на добавление GitHub Actions и интеграции с отчётностью подтверждены.
- Допускается настройка дополнительного бота или инструмента (Codecov, Coveralls) для отображения детализированного покрытия, если бесплатный план покрывает потребности.
- Любые тесты, требующие внешних API или базы данных, будут использовать тестовые двойники или Supabase в режиме sandbox с фикстурами, чтобы не искажать результаты.
